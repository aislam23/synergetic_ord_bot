"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
"""
from datetime import datetime
from aiogram import Router, Bot
from aiogram.types import Message
from aiogram.filters import CommandStart, CommandObject

from app.database import db
from app.keyboards.creative import get_main_menu_keyboard
from app.config import settings
from app.utils.bot_commands import update_admin_commands

router = Router()


@router.message(CommandStart(deep_link=True))
async def start_with_invite_link(message: Message, command: CommandObject, bot: Bot):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start —Å –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–æ–π"""
    user = message.from_user
    invite_code = command.args
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É
    invite_link = await db.get_invite_link_by_code(invite_code)
    
    if not invite_link:
        await message.answer(
            "‚ùå <b>–ù–µ–≤–µ—Ä–Ω–∞—è –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞</b>\n\n"
            "–≠—Ç–∞ —Å—Å—ã–ª–∫–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞."
        )
        return
    
    if invite_link.is_used:
        await message.answer(
            "‚ùå <b>–°—Å—ã–ª–∫–∞ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞</b>\n\n"
            "–≠—Ç–∞ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ —É–∂–µ –±—ã–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –∏ –±–æ–ª—å—à–µ –Ω–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞.\n"
            "–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤–æ–π —Å—Å—ã–ª–∫–∏."
        )
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è
    if invite_link.expires_at and invite_link.expires_at < datetime.utcnow():
        await message.answer(
            "‚ùå <b>–°—Å—ã–ª–∫–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–∞</b>\n\n"
            "–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —ç—Ç–æ–π –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏ –∏—Å—Ç–µ–∫.\n"
            "–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤–æ–π —Å—Å—ã–ª–∫–∏."
        )
        return
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Å—ã–ª–∫—É –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await db.use_invite_link(invite_code, user.id)
    
    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —É–∫–∞–∑–∞–Ω–Ω–æ–π —Ä–æ–ª—å—é
    await db.add_user_with_invite(
        user_id=user.id,
        username=user.username,
        first_name=user.first_name,
        last_name=user.last_name,
        full_name=invite_link.full_name,
        role=invite_link.target_role,
        invited_by=invite_link.created_by
    )
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    try:
        is_admin = invite_link.target_role == "admin"
        await update_admin_commands(bot, user.id, is_admin)
    except Exception as e:
        # –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã
        pass
    
    # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    role_text = "–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞" if invite_link.target_role == "admin" else "—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞"
    
    welcome_text = f"""
‚úÖ <b>–£—Å–ø–µ—à–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è!</b>

üëã –ü—Ä–∏–≤–µ—Ç, {invite_link.full_name or user.first_name or '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}!

–í—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ –±–æ—Ç–µ –∫–∞–∫ <b>{role_text}</b>.

<b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ Erid!</b>

–≠—Ç–æ—Ç –±–æ—Ç –ø–æ–º–æ–∂–µ—Ç –≤–∞–º —Å–æ–∑–¥–∞—Ç—å –∫—Ä–µ–∞—Ç–∏–≤—ã —Å–∞–º–æ—Ä–µ–∫–ª–∞–º—ã –∏ –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω—ã Erid —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å –ú–µ–¥–∏–∞—Å–∫–∞—É—Ç.

üé® <b>–ß—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:</b>
‚Ä¢ –°–æ–∑–¥–∞—Ç—å –∫—Ä–µ–∞—Ç–∏–≤ –¥–ª—è —Å–∞–º–æ—Ä–µ–∫–ª–∞–º—ã
‚Ä¢ –í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ä–º—É –∫—Ä–µ–∞—Ç–∏–≤–∞ (–±–∞–Ω–Ω–µ—Ä, —Ç–µ–∫—Å—Ç, –≤–∏–¥–µ–æ –∏ —Ç.–¥.)
‚Ä¢ –ó–∞–≥—Ä—É–∑–∏—Ç—å –º–µ–¥–∏–∞-—Ñ–∞–π–ª—ã
‚Ä¢ –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω Erid

–î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /menu –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–∏–∂–µ:
"""
    
    await message.answer(
        welcome_text,
        reply_markup=get_main_menu_keyboard()
    )


@router.message(CommandStart())
async def start_command(message: Message, bot: Bot):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤"""
    user = message.from_user
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –±–∞–∑–µ
    existing_user = await db.get_user(user.id)
    
    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–æ–º –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
    if not existing_user and not settings.is_admin(user.id):
        await message.answer(
            "‚ùå <b>–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω</b>\n\n"
            "–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.\n\n"
            "–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –≤–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞."
        )
        return
    
    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞, –Ω–æ –Ω–µ –≤ –±–∞–∑–µ - –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ
    if not existing_user and settings.is_admin(user.id):
        await db.add_user_with_invite(
            user_id=user.id,
            username=user.username,
            first_name=user.first_name,
            last_name=user.last_name,
            role="admin"
        )
        existing_user = await db.get_user(user.id)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –∞–¥–º–∏–Ω–∞
        try:
            await update_admin_commands(bot, user.id, is_admin=True)
        except Exception as e:
            # –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã
            pass
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    if existing_user and existing_user.is_blocked:
        await message.answer(
            "üö´ <b>–î–æ—Å—Ç—É–ø –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</b>\n\n"
            "–í–∞—à –¥–æ—Å—Ç—É–ø –∫ –±–æ—Ç—É –±—ã–ª –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.\n\n"
            "–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."
        )
        return
    
    # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    welcome_text = f"""
üëã –ü—Ä–∏–≤–µ—Ç, {user.first_name or '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}!

<b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ Erid!</b>

–≠—Ç–æ—Ç –±–æ—Ç –ø–æ–º–æ–∂–µ—Ç –≤–∞–º —Å–æ–∑–¥–∞—Ç—å –∫—Ä–µ–∞—Ç–∏–≤—ã —Å–∞–º–æ—Ä–µ–∫–ª–∞–º—ã –∏ –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω—ã Erid —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å –ú–µ–¥–∏–∞—Å–∫–∞—É—Ç.

üé® <b>–ß—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:</b>
‚Ä¢ –°–æ–∑–¥–∞—Ç—å –∫—Ä–µ–∞—Ç–∏–≤ –¥–ª—è —Å–∞–º–æ—Ä–µ–∫–ª–∞–º—ã
‚Ä¢ –í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ä–º—É –∫—Ä–µ–∞—Ç–∏–≤–∞ (–±–∞–Ω–Ω–µ—Ä, —Ç–µ–∫—Å—Ç, –≤–∏–¥–µ–æ –∏ —Ç.–¥.)
‚Ä¢ –ó–∞–≥—Ä—É–∑–∏—Ç—å –º–µ–¥–∏–∞-—Ñ–∞–π–ª—ã
‚Ä¢ –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω Erid

–î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /menu –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–∏–∂–µ:
"""
    
    await message.answer(
        welcome_text,
        reply_markup=get_main_menu_keyboard()
    )
